generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  buyer
  seller
  admin
}

enum KycStatus {
  pending
  verified
  rejected
}

enum OrderStatus {
  placed
  accepted
  packed
  out_for_delivery
  delivered
  cancelled
}

enum PaymentMode {
  cod
  online
}

enum PaymentStatus {
  pending
  success
  failed
}

enum CodStatus {
  pending
  settled
}

model User {
  id        String   @id @default(uuid())
  phone     String   @unique
  name      String?
  role      UserRole @default(buyer)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  seller    Seller?
  orders    Order[]  @relation("BuyerOrders")
}

model Seller {
  id        String   @id @default(uuid())
  userId    String   @unique
  legalName String
  gstin     String?
  kycStatus KycStatus @default(pending)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user  User  @relation(fields: [userId], references: [id])
  shops Shop[]
}

model Shop {
  id        String   @id @default(uuid())
  sellerId  String
  name      String
  address1  String
  address2  String?
  city      String
  state     String
  pincode   String
  lat       Decimal
  lng       Decimal
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  seller   Seller   @relation(fields: [sellerId], references: [id])
  products Product[]
  orders   Order[]
}

model Product {
  id          String   @id @default(uuid())
  shopId      String
  name        String
  description String?
  category    String
  price       Int
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  shop      Shop      @relation(fields: [shopId], references: [id])
  inventory Inventory?
  orderItems OrderItem[]
}

model Inventory {
  id        String   @id @default(uuid())
  productId String   @unique
  quantity  Int
  reserved  Int
  updatedAt DateTime @updatedAt

  product Product @relation(fields: [productId], references: [id])
}

model Order {
  id          String      @id @default(uuid())
  buyerId     String
  shopId      String
  status      OrderStatus @default(placed)
  subtotal    Int
  deliveryFee Int
  total       Int
  paymentMode PaymentMode
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  buyer      User      @relation("BuyerOrders", fields: [buyerId], references: [id])
  shop       Shop      @relation(fields: [shopId], references: [id])
  items      OrderItem[]
  payment    Payment?
  codSettlement CodSettlement?
  commission Commission?
}

model OrderItem {
  id        String  @id @default(uuid())
  orderId   String
  productId String
  quantity  Int
  price     Int

  order   Order   @relation(fields: [orderId], references: [id])
  product Product @relation(fields: [productId], references: [id])
}

model Payment {
  id        String        @id @default(uuid())
  orderId   String        @unique
  provider  String
  status    PaymentStatus @default(pending)
  amount    Int
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  order Order @relation(fields: [orderId], references: [id])
}

model CodSettlement {
  id        String   @id @default(uuid())
  orderId   String   @unique
  status    CodStatus @default(pending)
  amount    Int
  settledAt DateTime?

  order Order @relation(fields: [orderId], references: [id])
}

model Commission {
  id        String   @id @default(uuid())
  orderId   String   @unique
  rateBps   Int
  amount    Int
  createdAt DateTime @default(now())

  order Order @relation(fields: [orderId], references: [id])
}
